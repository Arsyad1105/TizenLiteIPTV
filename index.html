<!DOCTYPE html>
<html lang="en">
<head>
    <title>Bitmovin Demo</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet">

    <!-- Bitmovin player modules -->
    <link href="https://cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-core.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-polyfill.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-engine-bitmovin.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-mserenderer.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-abr.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-drm.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-container-mp4.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-container-ts.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-xml.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-dash.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-hls.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-crypto.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-style.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-smooth.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-tizen.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.js"></script>
    <link rel="stylesheet" href="https://cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.css">

    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="css/bitmovin-demo.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f8f8;
            color: #333;
        }

        h1 {
            margin-top: 20px;
            color: #333;
        }

        #channelList {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        #channelList li {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            color: #333;
            background-color: #fff;
        }

        #channelList li.selected {
            background-color: #007bff;
            color: #fff;
        }

        #channelList li:hover {
            background-color: #e0e0e0;
        }

        #playerContainer {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position to overlay other content */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent background */
            z-index: 1000; /* Ensure it's on top of other elements */
        }

        #player {
            width: 100%;
            height: 100%;
        }

        #errorContainer {
            color: red;
            margin-top: 20px;
        }

        #m3uUrlInput {
            width: 80%;
            padding: 10px;
            margin: 20px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: #000;
            background-color: #fff;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <div id="banner">
        <div class="logo"><a href="https://bitmovin.com"><img src="images/bitmovin-logo.png"></a></div>
        <div class="title"><h1 class="bitmovin-headline">Bitmovin Player Demo</h1></div>
        <div class="clearfix"></div>
    </div>

    <div class="container-fluid">
        <div class="content">
            <div class="row bitmovin-description">
                <div class="col-lg-12 text-center" id="source-description">
                    <h3>Live TV Channels</h3>
                    <input type="text" id="m3uUrlInput" placeholder="Enter M3U URL..."/>
                    <button onclick="loadM3U()">Load M3U</button>
                </div>
            </div>

            <div class="row bitmovin-player-row">
                <div class="col-lg-12" id="playerWrapper">
                    <ul id="channelList"></ul>
                    <div id="errorContainer"></div>
                    <div id="playerContainer">
                        <div id="player"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let player;
    const playerConfig = {
        key: 'YOUR_BITMOVIN_KEY'
    };

    document.addEventListener('DOMContentLoaded', function() {
        player = new bitmovin.player.Player(document.getElementById('player'), playerConfig);
    });

    function parseM3U(content) {
        const lines = content.split('\n');
        const channels = [];
        let currentChannel = {};

        lines.forEach(line => {
            line = line.trim();
            if (line.startsWith('#EXTINF:')) {
                const [, info] = line.split('#EXTINF:');
                const [duration, ...rest] = info.split(',');
                currentChannel = { duration: parseInt(duration, 10), name: rest.join(',').trim() };
            } if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                // Extract the license URL for Widevine
                const [, licenseKey] = line.split('inputstream.adaptive.license_key=');
                currentChannel.licenseKey = licenseKey;
            } if (line.startsWith('#KODIPROP:inputstream.adaptive.license_type=com.widevine.alpha')) {
                // Indicate that the DRM type is Widevine
                currentChannel.drmType = 'widevine';
            } if (line && !line.startsWith('#')) {
                currentChannel.url = line;
                channels.push(currentChannel);
                currentChannel = {};
            }
        });

        return channels;
    }

    function loadM3U() {
        const url = document.getElementById('m3uUrlInput').value;
        if (!url) {
            alert('Please enter a valid M3U URL.');
            return;
        }

        fetch(url)
            .then(response => response.text())
            .then(data => {
                const channels = parseM3U(data);
                displayChannels(channels);
            })
            .catch(error => {
                console.error('Error loading M3U file:', error);
                document.getElementById('errorContainer').textContent = 'Error loading M3U file.';
            });
    }

    function displayChannels(channels) {
        const channelList = document.getElementById('channelList');
        channelList.innerHTML = '';
        channels.forEach((channel, index) => {
            const li = document.createElement('li');
            li.textContent = channel.name;
            li.onclick = () => {
                playChannel(channel);
                highlightSelectedChannel(index);
            };
            channelList.appendChild(li);
        });
    }

    function highlightSelectedChannel(index) {
        const channelListItems = document.querySelectorAll('#channelList li');
        channelListItems.forEach((item, idx) => {
            item.classList.toggle('selected', idx === index);
        });
    }

    function playChannel(channel) {
        const url = channel.url;
        const isDASH = url.includes('.mpd');
        const isHLS = url.includes('.m3u8');

        let source;
        let drmConfig = {};

        if (isDASH) {
            source = { dash: url, title: channel.name };

            // If Widevine DRM is present, set DRM configuration with LA_URL
            if (channel.drmType === 'widevine' && channel.licenseKey) {
                console.log('Setting Widevine DRM with license URL:', channel.licenseKey);
                drmConfig = {
                    widevine: {
                        LA_URL: channel.licenseKey
                    }
                };
            }
        } else if (isHLS) {
            source = { hls: url, title: channel.name };
        } else {
            console.error('Unsupported stream type:', url);
            return;
        }

        // Show the player container as overlay
        const playerContainer = document.getElementById('playerContainer');
        playerContainer.style.display = 'block';

        // Ensure the player is initialized and then load the source
        if (player) {
            if (Object.keys(drmConfig).length > 0) {
                player.setDRM(drmConfig);
            }

            player.load(source).then(() => {
                console.log(`Playing channel: ${channel.name}`);
            }).catch(error => {
                console.error(`Error playing channel: ${channel.name}`, error);
            });
        } else {
            console.error('Player is not initialized.');
        }
    }
</script>
</body>
</html>
