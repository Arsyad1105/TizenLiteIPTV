<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Player</title>
    <link rel="stylesheet" href="https://cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f8f8;
            color: #333;
            margin: 0;
            overflow: hidden; /* Prevent scrolling when player is full-screen */
        }

        h1 {
            margin-top: 20px;
            color: #333;
        }

        #channelList {
            list-style: none;
            padding: 0;
            text-align: left;
            margin: 20px auto;
            width: 80%;
        }

        #channelList li {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            color: #333;
            background-color: #fff;
        }

        #channelList li:hover {
            background-color: #e0e0e0;
        }

        #playerContainer {
            position: fixed; /* Position fixed for full-screen */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: none; /* Initially hidden */
            z-index: 1000; /* Ensure it's on top of other elements */
        }

        #errorContainer {
            color: red;
            margin-top: 20px;
        }

        #m3uUrlInput {
            width: 80%;
            padding: 10px;
            margin: 20px auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: #000;
            background-color: #fff;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>IPTV Player</h1>
    <input type="text" id="m3uUrlInput" placeholder="Enter M3U URL">
    <button id="loadM3UButton">Load M3U</button>
    <ul id="channelList"></ul>
    <div id="playerContainer">
        <div id="player"></div>
    </div>
    <div id="errorContainer"></div>

    <script src="https://cdn.bitmovin.com/player/web/8/bitmovinplayer.min.js"></script>
    <script>
        let player;

        document.getElementById('loadM3UButton').addEventListener('click', () => {
            const url = document.getElementById('m3uUrlInput').value;
            if (url) {
                loadM3U(url);
            }
        });

        function loadM3U(url) {
            fetch(url)
                .then(response => response.text())
                .then(content => {
                    const channels = parseM3U(content);
                    displayChannels(channels);
                })
                .catch(error => {
                    console.error('Error fetching M3U:', error);
                    document.getElementById('errorContainer').textContent = `Error loading M3U: ${error.message}`;
                });
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            let currentChannel = {};

            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    const [, info] = line.split('#EXTINF:');
                    const [duration, ...rest] = info.split(',');
                    currentChannel = { duration: parseInt(duration, 10), name: rest.join(',').trim() };
                } else if (line && !line.startsWith('#')) {
                    currentChannel.url = line;
                    channels.push(currentChannel);
                    currentChannel = {};
                }
            });

            return channels;
        }

        function displayChannels(channels) {
            const channelList = document.getElementById('channelList');
            channelList.innerHTML = '';

            channels.forEach(channel => {
                const li = document.createElement('li');
                li.textContent = channel.name;
                li.onclick = () => playChannel(channel);
                channelList.appendChild(li);
            });
        }

        function playChannel(channel) {
            const playerContainer = document.getElementById('playerContainer');
            const source = {
                title: channel.name,
            };

            // Detect the type of stream based on the URL
            if (channel.url.includes('.m3u8')) {
                source.hls = channel.url;
            } else if (channel.url.includes('.mpd')) {
                source.dash = channel.url;
            } else if (channel.url.includes('kodiprop') || channel.url.includes('widevine')) {
                source.drm = {
                    widevine: {
                        LA_URL: channel.url
                    }
                };
            } else {
                document.getElementById('errorContainer').textContent = 'Unsupported URL format.';
                return;
            }

            if (!player) {
                setupPlayer();
            }

            playerContainer.style.display = 'block'; // Show the player container
            player.load(source).then(() => {
                console.log(`Playing channel: ${channel.name}`);
            }).catch(error => {
                console.error(`Error playing channel: ${channel.name}`, error);
                document.getElementById('errorContainer').textContent = `Player error: ${error.message}`;
            });
        }

        function setupPlayer() {
            const container = document.getElementById('player');
            
            // Ensure the Bitmovin player script is loaded and accessible
            if (typeof bitmovin !== 'undefined' && bitmovin.player) {
                const conf = {
                    key: "1a69b597-a4b2-4bf7-99ba-bd417397c111",
                    playback: {
                        autoplay: true,
                    },
                    tweaks: {
                        file_protocol: true,
                        app_id: "com.bitmovin.demo.webapp",
                        BACKWARD_BUFFER_PURGE_INTERVAL: 10,
                    },
                    ui: false,
                };

                player = new bitmovin.player.Player(container, conf);

                player.on(bitmovin.player.PlayerEvent.Warning, function(data) {
                    console.log("Warning Event: " + JSON.stringify(data));
                });

                player.on(bitmovin.player.PlayerEvent.Error, function(data) {
                    console.log("Error Event: " + JSON.stringify(data));
                    document.getElementById('errorContainer').textContent = `Player error: ${data.message}`;
                });
            } else {
                document.getElementById('errorContainer').textContent = 'Bitmovin Player not loaded.';
            }
        }
    </script>
</body>
</html>
